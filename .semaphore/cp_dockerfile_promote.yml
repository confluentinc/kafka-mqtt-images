# This file is managed by ServiceBot plugin - Semaphore. The content in this file is created using a common
# template and configurations in service.yml.
# Any modifications made to ths file will be overwritten by the generated content in nightly runs.
# For more information, please refer to the page:
# https://confluentinc.atlassian.net/wiki/spaces/Foundations/pages/2871296194/Add+SemaphoreCI
version: v1.0
name: build-test-release
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1

fail_fast:
  cancel:
    when: "true"

execution_time_limit:
  hours: 1

queue:
  - when: "branch != 'master' and branch !~ '[0-9]+\\.[0-9]+\\.[0-9]+'"
    processing: parallel

global_job_config:
  prologue:
    commands:
      - checkout
      - . vault-setup
      # Semaphore does not accept empty values for parameters.
      - if [[ -z "$CONFLUENT_VERSION" ]]; then echo "Must specify CONFLUENT_VERSION" && exit 1; fi
      - if [[ -z "$IMAGE_REVISION" ]]; then echo "Must specify IMAGE_REVISION" && exit 1; fi
      - if [[ -z "$PROMOTE_OS_TYPE" ]]; then echo "Must specify PROMOTE_OS_TYPE" && exit 1; fi
      - >-
        echo """
        Parameters:
        ==========================
        CONFLUENT_VERSION: $CONFLUENT_VERSION
        IMAGE_REVISION: $IMAGE_REVISION
        UPDATE_LATEST_TAG: $UPDATE_LATEST_TAG
        PACKAGING_BUILD_NUMBER: $PACKAGING_BUILD_NUMBER
        PROMOTE_OS_TYPE: $PROMOTE_OS_TYPE
        """
      - export BRANCH_TAG=$(echo $SEMAPHORE_GIT_BRANCH | tr / -)
      - export DOCKER_PROD_REGISTRY="519856050701.dkr.ecr.us-west-2.amazonaws.com/docker/prod/"
      - export PROMOTED_TAG_PREFIX="$CONFLUENT_VERSION-$IMAGE_REVISION"
      - if [[ ! "$PACKAGING_BUILD_NUMBER" ]]; then export $PACKAGING_BUILD_NUMBER="latest"; fi
      - docker login --username $DOCKERHUB_USER --password $DOCKERHUB_APIKEY
      - export AMD_ARCH=.amd64

blocks:
  - name: Promote AMD
    dependencies: []
    task:
      jobs:
  - name: Create Manifest
    dependencies: ["Promote AMD"]
    task:
      jobs:
